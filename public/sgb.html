<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SISTEMA DE GESTÃO BRABO v5.0</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      background-color: #1a202c;
      color: #e2e8f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .tab-active {
      background-color: #4299e1;
      color: white;
    }
    .tab-inactive {
      background-color: #2d3748;
      color: #e2e8f0;
    }
    .tab-inactive:hover {
      background-color: #4a5568;
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- TELA DE LOGIN / BLOQUEIO -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 hidden">
    <div class="bg-[#2d3748] p-8 rounded-2xl max-w-md w-full shadow-xl text-center">
      <h1 class="text-2xl font-bold mb-4">SISTEMA DE GESTÃO BRABO v5.0</h1>
      <p class="text-sm text-gray-300 mb-6">
        Faça login com sua conta do Google autorizada para acessar o sistema.
      </p>
      <p id="login-error" class="text-sm text-red-300 mt-2 hidden"></p>
    </div>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="app" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto hidden">
    <!-- Cabeçalho -->
    <header class="flex flex-wrap justify-between items-center gap-4 mb-6">
      <div>
        <h1 class="text-3xl sm:text-4xl font-extrabold text-white">
          SISTEMA DE GESTÃO BRABO v5.0
        </h1>
        <div class="mt-2 flex items-center gap-3">
          <label class="text-sm text-gray-300">Unidade:</label>
          <select
            id="unit-selector"
            class="bg-[#2d3748] border border-gray-600 text-white text-sm rounded-lg p-2"
          ></select>
        </div>
      </div>

      <!-- Bloco interno de usuário oculto (usado só pelo JS) -->
      <div class="hidden">
        <span id="user-email"></span>
      </div>
    </header>

    <!-- Abas -->
    <nav class="flex flex-wrap gap-2 mb-6">
      <button data-tab="visaoGeral" class="tab-btn tab-active py-2 px-4 rounded-lg text-sm font-semibold">
        Visão Geral
      </button>
      <button data-tab="alunos" class="tab-btn tab-inactive py-2 px-4 rounded-lg text-sm font-semibold">
        Alunos
      </button>
      <button data-tab="funcionarios" class="tab-btn tab-inactive py-2 px-4 rounded-lg text-sm font-semibold">
        Funcionários
      </button>
      <button data-tab="planos" class="tab-btn tab-inactive py-2 px-4 rounded-lg text-sm font-semibold">
        Planos
      </button>
      <button data-tab="lancamentos" class="tab-btn tab-inactive py-2 px-4 rounded-lg text-sm font-semibold">
        Lançamentos
      </button>
      <button data-tab="relatorios" class="tab-btn tab-inactive py-2 px-4 rounded-lg text-sm font-semibold">
        Relatórios
      </button>
    </nav>

    <!-- Conteúdo das Abas -->
    <main>
      <!-- VISÃO GERAL -->
      <section id="tab-visaoGeral" class="tab-content">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-[#2d3748] p-4 rounded-xl shadow">
            <div class="text-sm text-gray-300 mb-1">Receita Bruta</div>
            <div id="kpi-receita" class="text-3xl font-bold">R$ 0,00</div>
          </div>
          <div class="bg-[#2d3748] p-4 rounded-xl shadow">
            <div class="text-sm text-gray-300 mb-1">Custo Total</div>
            <div id="kpi-custo" class="text-3xl font-bold">R$ 0,00</div>
          </div>
          <div class="bg-[#2d3748] p-4 rounded-xl shadow">
            <div class="text-sm text-gray-300 mb-1">Saldo</div>
            <div id="kpi-saldo" class="text-3xl font-bold">R$ 0,00</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="bg-[#2d3748] p-4 rounded-xl shadow lg:col-span-2">
            <h3 class="text-lg font-bold mb-3">Receita vs. Despesas (Mês Atual)</h3>
            <canvas id="chart-receita-despesa"></canvas>
          </div>
          <div class="bg-[#2d3748] p-4 rounded-xl shadow">
            <h3 class="text-lg font-bold mb-3">Top 5 Despesas</h3>
            <canvas id="chart-despesas-top"></canvas>
          </div>
        </div>
      </section>

      <!-- ALUNOS -->
      <section id="tab-alunos" class="tab-content hidden">
        <div class="bg-[#2d3748] p-4 rounded-xl shadow mb-4 flex justify-between items-center">
          <h3 class="text-lg font-bold">Alunos</h3>
          <button
            id="btn-add-aluno"
            class="bg-[#4299e1] hover:bg-[#3182ce] text-white font-semibold py-2 px-4 rounded-lg text-sm"
          >
            Novo Aluno
          </button>
        </div>
        <div class="bg-[#2d3748] p-4 rounded-xl shadow overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="border-b border-gray-600">
                <th class="p-2">Nome</th>
                <th class="p-2">Email</th>
                <th class="p-2">Status</th>
                <th class="p-2">Criado por</th>
              </tr>
            </thead>
            <tbody id="table-alunos"></tbody>
          </table>
        </div>
      </section>

      <!-- FUNCIONÁRIOS -->
      <section id="tab-funcionarios" class="tab-content hidden">
        <div class="bg-[#2d3748] p-4 rounded-xl shadow mb-4 flex justify-between items-center">
          <h3 class="text-lg font-bold">Funcionários</h3>
          <button
            id="btn-add-funcionario"
            class="bg-[#4299e1] hover:bg-[#3182ce] text-white font-semibold py-2 px-4 rounded-lg text-sm"
          >
            Novo Funcionário
          </button>
        </div>
        <div class="bg-[#2d3748] p-4 rounded-xl shadow overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="border-b border-gray-600">
                <th class="p-2">Nome</th>
                <th class="p-2">Cargo</th>
                <th class="p-2 text-right">Salário Base</th>
                <th class="p-2">Criado por</th>
              </tr>
            </thead>
            <tbody id="table-funcionarios"></tbody>
          </table>
        </div>
      </section>

      <!-- PLANOS -->
      <section id="tab-planos" class="tab-content hidden">
        <div class="bg-[#2d3748] p-4 rounded-xl shadow mb-4 flex justify-between items-center">
          <h3 class="text-lg font-bold">Planos</h3>
          <button
            id="btn-add-plano"
            class="bg-[#4299e1] hover:bg-[#3182ce] text-white font-semibold py-2 px-4 rounded-lg text-sm"
          >
            Novo Plano
          </button>
        </div>
        <div class="bg-[#2d3748] p-4 rounded-xl shadow overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="border-b border-gray-600">
                <th class="p-2">Nome</th>
                <th class="p-2 text-right">Valor</th>
                <th class="p-2">Status</th>
                <th class="p-2">Criado por</th>
              </tr>
            </thead>
            <tbody id="table-planos"></tbody>
          </table>
        </div>
      </section>

      <!-- LANÇAMENTOS -->
      <section id="tab-lancamentos" class="tab-content hidden">
        <div class="bg-[#2d3748] p-4 rounded-xl shadow mb-4 flex justify-between items-center">
          <h3 class="text-lg font-bold">Lançamentos</h3>
          <button
            id="btn-add-lancamento"
            class="bg-[#4299e1] hover:bg-[#3182ce] text-white font-semibold py-2 px-4 rounded-lg text-sm"
          >
            Novo Lançamento
          </button>
        </div>
        <div class="bg-[#2d3748] p-4 rounded-xl shadow overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="border-b border-gray-600">
                <th class="p-2">Descrição</th>
                <th class="p-2">Categoria</th>
                <th class="p-2">Tipo</th>
                <th class="p-2 text-right">Valor</th>
                <th class="p-2">Vencimento</th>
                <th class="p-2">Criado por</th>
              </tr>
            </thead>
            <tbody id="table-lancamentos"></tbody>
          </table>
        </div>
      </section>

      <!-- RELATÓRIOS -->
      <section id="tab-relatorios" class="tab-content hidden">
        <div class="bg-[#2d3748] p-4 rounded-xl shadow">
          <h3 class="text-lg font-bold mb-4">Relatórios (resumo do período atual)</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-[#1f2937] p-4 rounded-lg">
              <div class="text-sm text-gray-300 mb-1">Receita Bruta</div>
              <div id="rel-receita" class="text-2xl font-bold">R$ 0,00</div>
            </div>
            <div class="bg-[#1f2937] p-4 rounded-lg">
              <div class="text-sm text-gray-300 mb-1">Custo Total</div>
              <div id="rel-custo" class="text-2xl font-bold">R$ 0,00</div>
            </div>
            <div class="bg-[#1f2937] p-4 rounded-lg">
              <div class="text-sm text-gray-300 mb-1">Saldo</div>
              <div id="rel-saldo" class="text-2xl font-bold">R$ 0,00</div>
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-4">
            Fase 2: vamos poder detalhar auditoria, filtros avançados, exportação, etc.
          </p>
        </div>
      </section>
    </main>
  </div>

  <script>
    // =========================
    // CONFIGURAÇÃO FIREBASE
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyBEId876zarlIjEKYUz7ejnLhLcstnsHY7Y",
      authDomain: "sistemadegestaobrabo.firebaseapp.com",
      projectId: "sistemadegestaobrabo",
      storageBucket: "sistemadegestaobrabo.firebasestorage.app",
      messagingSenderId: "1050063988219",
      appId: "1:1050063988219:web:d5a4b3d1305144840675e"
    };

    const allowedEmails = [
      "thiagobrabobm@gmail.com",
      "marlucezanco02@gmail.com"
    ];

    const UNITS = [
      "Academia Zanco - Cordovil",
      "Academia Zanco - Irajá 1",
      "Academia Zanco - Irajá 2",
      "Academia Zanco - Vila da Penha",
      "Academia Zanco - Brás de Pina",
      "Academia Zanco - Caxias"
    ];

    let currentUser = null;
    let selectedUnit = UNITS[0];
    let db, auth;
    let unsubscribers = [];

    const state = {
      planos: [],
      alunos: [],
      funcionarios: [],
      lancamentos: []
    };

    let chartReceitaDespesa = null;
    let chartTopDespesas = null;

    // =========================
    // UTIL
    // =========================
    function formatBRL(value) {
      const n = Number(value || 0);
      return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    const fmtDate = (d) => {
      if (!d) return "--";
      const date = d instanceof Date ? d : new Date(d);
      if (isNaN(date)) return "--";
      return date.toLocaleString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    };

    function showBlocked(message) {
      const loginScreen = document.getElementById("login-screen");
      const appDiv = document.getElementById("app");
      const err = document.getElementById("login-error");

      if (appDiv) appDiv.classList.add("hidden");
      if (loginScreen) loginScreen.classList.remove("hidden");

      if (err) {
        err.textContent = message;
        err.classList.remove("hidden");
      }
    }

    // =========================
    // FIREBASE INIT
    // =========================
    function initFirebase() {
      try {
        if (!firebase.apps || firebase.apps.length === 0) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        auth = firebase.auth();
      } catch (e) {
        console.error("[SGB] Falha ao inicializar Firebase:", e);
        showBlocked("Erro ao inicializar o Firebase. Verifique o console.");
      }
    }

    // =========================
    // EMAIL DA URL
    // =========================
    function getUserEmailFromUrl() {
      try {
        const params = new URLSearchParams(window.location.search || "");
        const email = params.get("userEmail");
        return email ? email.trim().toLowerCase() : null;
      } catch (err) {
        console.error("[SGB] Erro ao ler userEmail da URL:", err);
        return null;
      }
    }

    // =========================
    // AUTH (VIA NEXTAUTH -> query param)
    // =========================
    function setupAuth() {
      const emailFromUrl = getUserEmailFromUrl();

      if (!emailFromUrl) {
        showBlocked("Erro: não foi possível identificar o usuário logado. Saia e faça login novamente.");
        return false;
      }

      if (!allowedEmails.includes(emailFromUrl)) {
        showBlocked("Acesso negado: este e-mail não está autorizado para usar o sistema.");
        return false;
      }

      currentUser = { email: emailFromUrl };

      const userEmailSpan = document.getElementById("user-email");
      if (userEmailSpan) userEmailSpan.textContent = currentUser.email;

      // libera o app
      const loginScreen = document.getElementById("login-screen");
      const appDiv = document.getElementById("app");
      if (loginScreen) loginScreen.classList.add("hidden");
      if (appDiv) appDiv.classList.remove("hidden");

      return true;
    }

    // =========================
    // LISTEN FIRESTORE
    // =========================
    function listenUnit(unitId) {
      unsubscribers.forEach((u) => u && u());
      unsubscribers = [];

      state.planos = [];
      state.alunos = [];
      state.funcionarios = [];
      state.lancamentos = [];

      if (!db) return;

      const unitRef = db.collection("unidades").doc(unitId);

      unsubscribers.push(
        unitRef.collection("planos").onSnapshot((snap) => {
          state.planos = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          renderPlanos();
        })
      );

      unsubscribers.push(
        unitRef.collection("alunos").onSnapshot((snap) => {
          state.alunos = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          renderAlunos();
        })
      );

      unsubscribers.push(
        unitRef.collection("funcionarios").onSnapshot((snap) => {
          state.funcionarios = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          renderFuncionarios();
        })
      );

      unsubscribers.push(
        unitRef.collection("lancamentos")
          .orderBy("dataVencimento", "desc")
          .onSnapshot((snap) => {
            state.lancamentos = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
            renderLancamentos();
            updateKPIsAndCharts();
          })
      );
    }

    // =========================
    // UI
    // =========================
    function renderUnitsSelector() {
      const sel = document.getElementById("unit-selector");
      if (!sel) return;

      sel.innerHTML = "";
      UNITS.forEach((u) => {
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        if (u === selectedUnit) opt.selected = true;
        sel.appendChild(opt);
      });

      sel.addEventListener("change", (e) => {
        selectedUnit = e.target.value;
        listenUnit(selectedUnit);
      });
    }

    function renderAlunos() {
      const tbody = document.getElementById("table-alunos");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (state.alunos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-2 text-gray-400">Nenhum aluno cadastrado.</td></tr>`;
        return;
      }

      state.alunos.forEach((a) => {
        const createdAt = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : a.createdAt) : null;
        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700 hover:bg-gray-700/40";
        tr.innerHTML = `
          <td class="p-2">${a.nome_completo || "--"}</td>
          <td class="p-2">${a.email || "--"}</td>
          <td class="p-2">${a.status_aluno || "Ativo"}</td>
          <td class="p-2 text-xs text-gray-300">${a.createdBy || "--"} ${createdAt ? "(" + fmtDate(createdAt) + ")" : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderFuncionarios() {
      const tbody = document.getElementById("table-funcionarios");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (state.funcionarios.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-2 text-gray-400">Nenhum funcionário cadastrado.</td></tr>`;
        return;
      }

      state.funcionarios.forEach((f) => {
        const createdAt = f.createdAt ? (f.createdAt.toDate ? f.createdAt.toDate() : f.createdAt) : null;
        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700 hover:bg-gray-700/40";
        tr.innerHTML = `
          <td class="p-2">${f.nome || "--"}</td>
          <td class="p-2">${f.cargo || "--"}</td>
          <td class="p-2 text-right">${formatBRL(f.salario_base)}</td>
          <td class="p-2 text-xs text-gray-300">${f.createdBy || "--"} ${createdAt ? "(" + fmtDate(createdAt) + ")" : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderPlanos() {
      const tbody = document.getElementById("table-planos");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (state.planos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-2 text-gray-400">Nenhum plano cadastrado.</td></tr>`;
        return;
      }

      state.planos.forEach((p) => {
        const createdAt = p.createdAt ? (p.createdAt.toDate ? p.createdAt.toDate() : p.createdAt) : null;
        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700 hover:bg-gray-700/40";
        tr.innerHTML = `
          <td class="p-2">${p.nome_plano || "--"}</td>
          <td class="p-2 text-right">${formatBRL(p.valor)}</td>
          <td class="p-2">${p.status_plano || "Ativo"}</td>
          <td class="p-2 text-xs text-gray-300">${p.createdBy || "--"} ${createdAt ? "(" + fmtDate(createdAt) + ")" : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderLancamentos() {
      const tbody = document.getElementById("table-lancamentos");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (state.lancamentos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="p-2 text-gray-400">Nenhum lançamento cadastrado.</td></tr>`;
        return;
      }

      state.lancamentos.forEach((l) => {
        const createdAt = l.createdAt ? (l.createdAt.toDate ? l.createdAt.toDate() : l.createdAt) : null;

        const valor = Number(l.valor || 0);
        const tipo = l.tipo || "DESPESA";
        const sinal = tipo === "DESPESA" ? "-" : "+";
        const valorClass = tipo === "DESPESA" ? "text-red-300" : "text-green-300";

        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700 hover:bg-gray-700/40";
        tr.innerHTML = `
          <td class="p-2">${l.descricao || "--"}</td>
          <td class="p-2">${l.categoria || "--"}</td>
          <td class="p-2">${tipo}</td>
          <td class="p-2 text-right ${valorClass}">${sinal} ${formatBRL(valor)}</td>
          <td class="p-2">${l.dataVencimento || "--"}</td>
          <td class="p-2 text-xs text-gray-300">${l.createdBy || "--"} ${createdAt ? "(" + fmtDate(createdAt) + ")" : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // =========================
    // KPIs & CHARTS
    // =========================
    function updateKPIsAndCharts() {
      const receitaTotal = state.lancamentos
        .filter((l) => l.tipo === "RECEITA")
        .reduce((acc, l) => acc + Number(l.valor || 0), 0);

      const custoTotal = state.lancamentos
        .filter((l) => l.tipo === "DESPESA")
        .reduce((acc, l) => acc + Number(l.valor || 0), 0);

      const saldo = receitaTotal - custoTotal;

      const kpiReceita = document.getElementById("kpi-receita");
      const kpiCusto = document.getElementById("kpi-custo");
      const kpiSaldo = document.getElementById("kpi-saldo");

      const relReceita = document.getElementById("rel-receita");
      const relCusto = document.getElementById("rel-custo");
      const relSaldo = document.getElementById("rel-saldo");

      if (kpiReceita) kpiReceita.textContent = formatBRL(receitaTotal);
      if (kpiCusto) kpiCusto.textContent = formatBRL(custoTotal);
      if (kpiSaldo) kpiSaldo.textContent = formatBRL(saldo);

      if (relReceita) relReceita.textContent = formatBRL(receitaTotal);
      if (relCusto) relCusto.textContent = formatBRL(custoTotal);
      if (relSaldo) relSaldo.textContent = formatBRL(saldo);

      const canvas1 = document.getElementById("chart-receita-despesa");
      if (canvas1) {
        const ctx1 = canvas1.getContext("2d");
        if (chartReceitaDespesa) chartReceitaDespesa.destroy();
        chartReceitaDespesa = new Chart(ctx1, {
          type: "bar",
          data: {
            labels: ["Mês Atual"],
            datasets: [
              { label: "Receita", data: [receitaTotal], backgroundColor: "rgba(72, 187, 120, 0.7)" },
              { label: "Despesas", data: [custoTotal], backgroundColor: "rgba(245, 101, 101, 0.7)" }
            ]
          },
          options: { responsive: true }
        });
      }

      const despesasGrouped = {};
      state.lancamentos
        .filter((l) => l.tipo === "DESPESA")
        .forEach((l) => {
          const cat = l.categoria || "Outras";
          despesasGrouped[cat] = (despesasGrouped[cat] || 0) + Number(l.valor || 0);
        });

      const top = Object.entries(despesasGrouped)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      const canvas2 = document.getElementById("chart-despesas-top");
      if (canvas2) {
        const ctx2 = canvas2.getContext("2d");
        if (chartTopDespesas) chartTopDespesas.destroy();
        chartTopDespesas = new Chart(ctx2, {
          type: "doughnut",
          data: {
            labels: top.map(([k]) => k),
            datasets: [{ data: top.map(([, v]) => v) }]
          },
          options: { responsive: true }
        });
      }
    }

    // =========================
    // CRUD (PROMPT)
    // =========================
    function getUnitRef() {
      return db.collection("unidades").doc(selectedUnit);
    }

    async function addPlanoPrompt() {
      if (!currentUser?.email) return alert("Faça login antes.");
      const nome = prompt("Nome do plano:");
      if (!nome) return;
      const valorStr = prompt("Valor (R$):", "0");
      const valor = Number(valorStr || "0");

      await getUnitRef().collection("planos").add({
        nome_plano: nome,
        valor,
        status_plano: "Ativo",
        createdBy: currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser.email,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Plano criado com sucesso.");
    }

    async function addAlunoPrompt() {
      if (!currentUser?.email) return alert("Faça login antes.");
      const nome = prompt("Nome completo do aluno:");
      if (!nome) return;
      const email = prompt("Email do aluno:");
      if (!email) return;

      await getUnitRef().collection("alunos").add({
        nome_completo: nome,
        email,
        status_aluno: "Ativo",
        createdBy: currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser.email,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Aluno criado com sucesso.");
    }

    async function addFuncionarioPrompt() {
      if (!currentUser?.email) return alert("Faça login antes.");
      const nome = prompt("Nome do funcionário:");
      if (!nome) return;
      const cargo = prompt("Cargo:");
      if (!cargo) return;
      const salStr = prompt("Salário base (R$):", "0");
      const salario = Number(salStr || "0");

      await getUnitRef().collection("funcionarios").add({
        nome,
        cargo,
        salario_base: salario,
        status: "Ativo",
        createdBy: currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser.email,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Funcionário criado com sucesso.");
    }

    async function addLancamentoPrompt() {
      if (!currentUser?.email) return alert("Faça login antes.");
      const tipo = (prompt("Tipo (DESPESA ou RECEITA):", "DESPESA") || "").toUpperCase();
      if (!["DESPESA", "RECEITA"].includes(tipo)) return alert("Tipo inválido.");

      const descricao = prompt("Descrição do lançamento:");
      if (!descricao) return;
      const categoria = prompt("Categoria:");
      if (!categoria) return;

      const valStr = prompt("Valor (R$):", "0");
      const valor = Number(valStr || "0");
      const venc = prompt("Data de vencimento (YYYY-MM-DD):", new Date().toISOString().slice(0, 10));
      if (!venc) return;

      await getUnitRef().collection("lancamentos").add({
        tipo,
        descricao,
        categoria,
        valor,
        dataVencimento: venc,
        dataPagamento: null,
        createdBy: currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser.email,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Lançamento criado com sucesso.");
    }

    // =========================
    // ABAS
    // =========================
    function setupTabs() {
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.getAttribute("data-tab");

          tabButtons.forEach((b) => {
            b.classList.remove("tab-active");
            b.classList.add("tab-inactive");
          });
          btn.classList.remove("tab-inactive");
          btn.classList.add("tab-active");

          tabContents.forEach((section) => {
            if (section.id === "tab-" + tab) section.classList.remove("hidden");
            else section.classList.add("hidden");
          });
        });
      });
    }

    // =========================
    // START
    // =========================
    document.addEventListener("DOMContentLoaded", () => {
      initFirebase();

      const ok = setupAuth();
      if (!ok) return; // bloqueia aqui se não tiver email/sem permissão

      setupTabs();
      renderUnitsSelector();
      listenUnit(selectedUnit);

      document.getElementById("btn-add-plano")?.addEventListener("click", addPlanoPrompt);
      document.getElementById("btn-add-aluno")?.addEventListener("click", addAlunoPrompt);
      document.getElementById("btn-add-funcionario")?.addEventListener("click", addFuncionarioPrompt);
      document.getElementById("btn-add-lancamento")?.addEventListener("click", addLancamentoPrompt);
    });
  </script>
</body>
</html>
