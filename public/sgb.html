<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SISTEMA DE GESTÃO BRABO v5.0</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      background-color: #1a202c;
      color: #e2e8f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .tab-active { background-color: #4299e1; color: white; }
    .tab-inactive { background-color: #2d3748; color: #e2e8f0; }
    .tab-inactive:hover { background-color: #4a5568; }
  </style>
</head>

<body class="min-h-screen">

  <!-- TELA DE LOGIN / BLOQUEIO -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 hidden">
    <div class="bg-[#2d3748] p-8 rounded-2xl max-w-md w-full shadow-xl text-center">
      <h1 class="text-2xl font-bold mb-4">SISTEMA DE GESTÃO BRABO v5.0</h1>
      <p class="text-sm text-gray-300 mb-6">
        Faça login com sua conta do Google autorizada para acessar o sistema.
      </p>
      <p id="login-error" class="text-sm text-red-300 mt-2 hidden"></p>
    </div>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="app" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto hidden">
    <!-- Cabeçalho -->
    <header class="flex flex-wrap justify-between items-center gap-4 mb-6">
      <div>
        <h1 class="text-3xl sm:text-4xl font-extrabold text-white">
          SISTEMA DE GESTÃO BRABO v5.0
        </h1>
        <div class="mt-2 flex items-center gap-3">
          <label class="text-sm text-gray-300">Unidade:</label>
          <select
            id="unit-selector"
            class="bg-[#2d3748] border border-gray-600 text-white text-sm rounded-lg p-2"
          ></select>
        </div>
      </div>

      <!-- Bloco interno de usuário oculto (usado só pelo JS) -->
      <div class="hidden">
        <span id="user-email"></span>
      </div>
    </header>

    <!-- Abas -->
    <nav class="flex flex-wrap gap-2 mb-6">
      <button data-tab="visaoGeral" class="tab-btn tab-active py-2 px-4 rounded-lg text-sm font-semibold">
        Visão Geral
      </button>
      <button data-tab="alunos" class="tab-btn tab-inactive py-2 px-4 rounded-lg text-sm font-semibold">
        Alunos
      </button>
      <button data-tab="funcionarios" class="tab-btn tab-inactive py-2 px-4 rounded-lg text-sm font-semibold">
        Funcionários
      </button>
      <button data-tab="planos" class="tab-btn tab-inactive py-2 px-4 rounded-lg text-sm font-semibold">
        Planos
      </button>
      <button data-tab="lancamentos" class="tab-btn tab-inactive py-2 px-4 rounded-lg text-sm font-semibold">
        Lançamentos
      </button>
      <button data-tab="relatorios" class="tab-btn tab-inactive py-2 px-4 rounded-lg text-sm font-semibold">
        Relatórios
      </button>
    </nav>

    <!-- Conteúdo das Abas -->
    <main>
      <!-- VISÃO GERAL -->
      <section id="tab-visaoGeral" class="tab-content">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-[#2d3748] p-4 rounded-xl shadow">
            <div class="text-sm text-gray-300 mb-1">Receita Bruta</div>
            <div id="kpi-receita" class="text-3xl font-bold">R$ 0,00</div>
          </div>
          <div class="bg-[#2d3748] p-4 rounded-xl shadow">
            <div class="text-sm text-gray-300 mb-1">Custo Total</div>
            <div id="kpi-custo" class="text-3xl font-bold">R$ 0,00</div>
          </div>
          <div class="bg-[#2d3748] p-4 rounded-xl shadow">
            <div class="text-sm text-gray-300 mb-1">Saldo</div>
            <div id="kpi-saldo" class="text-3xl font-bold">R$ 0,00</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="bg-[#2d3748] p-4 rounded-xl shadow lg:col-span-2">
            <h3 class="text-lg font-bold mb-3">Receita vs. Despesas (Mês Atual)</h3>
            <canvas id="chart-receita-despesa"></canvas>
          </div>
          <div class="bg-[#2d3748] p-4 rounded-xl shadow">
            <h3 class="text-lg font-bold mb-3">Top 5 Despesas</h3>
            <canvas id="chart-despesas-top"></canvas>
          </div>
        </div>
      </section>

      <!-- ALUNOS -->
      <section id="tab-alunos" class="tab-content hidden">
        <div class="bg-[#2d3748] p-4 rounded-xl shadow mb-4 flex justify-between items-center">
          <h3 class="text-lg font-bold">Alunos</h3>
          <button
            id="btn-add-aluno"
            class="bg-[#4299e1] hover:bg-[#3182ce] text-white font-semibold py-2 px-4 rounded-lg text-sm"
          >
            Novo Aluno
          </button>
        </div>

        <div class="bg-[#2d3748] p-4 rounded-xl shadow overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="border-b border-gray-600">
                <th class="p-2">Nome</th>
                <th class="p-2">Email</th>
                <th class="p-2">Status</th>
                <th class="p-2">Desde</th>
                <th class="p-2">Criado por</th>
                <th class="p-2 text-right">Ações</th>
              </tr>
            </thead>
            <tbody id="table-alunos"></tbody>
          </table>
        </div>
      </section>

      <!-- FUNCIONÁRIOS -->
      <section id="tab-funcionarios" class="tab-content hidden">
        <div class="bg-[#2d3748] p-4 rounded-xl shadow mb-4 flex justify-between items-center">
          <h3 class="text-lg font-bold">Funcionários</h3>
          <button
            id="btn-add-funcionario"
            class="bg-[#4299e1] hover:bg-[#3182ce] text-white font-semibold py-2 px-4 rounded-lg text-sm"
          >
            Novo Funcionário
          </button>
        </div>

        <div class="bg-[#2d3748] p-4 rounded-xl shadow overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="border-b border-gray-600">
                <th class="p-2">Nome</th>
                <th class="p-2">Cargo</th>
                <th class="p-2">Desde</th>
                <th class="p-2 text-right">Salário</th>
                <th class="p-2">Criado por</th>
                <th class="p-2 text-right">Ações</th>
              </tr>
            </thead>
            <tbody id="table-funcionarios"></tbody>
          </table>
        </div>

        <p class="text-xs text-gray-400 mt-3">
          Dica: “Salário” aqui é por unidade selecionada (base + adicional da unidade).
        </p>
      </section>

      <!-- PLANOS -->
      <section id="tab-planos" class="tab-content hidden">
        <div class="bg-[#2d3748] p-4 rounded-xl shadow mb-4 flex justify-between items-center">
          <h3 class="text-lg font-bold">Planos</h3>
          <button
            id="btn-add-plano"
            class="bg-[#4299e1] hover:bg-[#3182ce] text-white font-semibold py-2 px-4 rounded-lg text-sm"
          >
            Novo Plano
          </button>
        </div>
        <div class="bg-[#2d3748] p-4 rounded-xl shadow overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="border-b border-gray-600">
                <th class="p-2">Nome</th>
                <th class="p-2 text-right">Valor</th>
                <th class="p-2">Status</th>
                <th class="p-2">Criado por</th>
              </tr>
            </thead>
            <tbody id="table-planos"></tbody>
          </table>
        </div>
      </section>

      <!-- LANÇAMENTOS -->
      <section id="tab-lancamentos" class="tab-content hidden">
        <div class="bg-[#2d3748] p-4 rounded-xl shadow mb-4 flex justify-between items-center">
          <h3 class="text-lg font-bold">Lançamentos</h3>
          <button
            id="btn-add-lancamento"
            class="bg-[#4299e1] hover:bg-[#3182ce] text-white font-semibold py-2 px-4 rounded-lg text-sm"
          >
            Novo Lançamento
          </button>
        </div>
        <div class="bg-[#2d3748] p-4 rounded-xl shadow overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="border-b border-gray-600">
                <th class="p-2">Descrição</th>
                <th class="p-2">Categoria</th>
                <th class="p-2">Tipo</th>
                <th class="p-2 text-right">Valor</th>
                <th class="p-2">Vencimento</th>
                <th class="p-2">Criado por</th>
              </tr>
            </thead>
            <tbody id="table-lancamentos"></tbody>
          </table>
        </div>
      </section>

      <!-- RELATÓRIOS -->
      <section id="tab-relatorios" class="tab-content hidden">
        <div class="bg-[#2d3748] p-4 rounded-xl shadow">
          <h3 class="text-lg font-bold mb-4">Relatórios (resumo do período atual)</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-[#1f2937] p-4 rounded-lg">
              <div class="text-sm text-gray-300 mb-1">Receita Bruta</div>
              <div id="rel-receita" class="text-2xl font-bold">R$ 0,00</div>
            </div>
            <div class="bg-[#1f2937] p-4 rounded-lg">
              <div class="text-sm text-gray-300 mb-1">Custo Total</div>
              <div id="rel-custo" class="text-2xl font-bold">R$ 0,00</div>
            </div>
            <div class="bg-[#1f2937] p-4 rounded-lg">
              <div class="text-sm text-gray-300 mb-1">Saldo</div>
              <div id="rel-saldo" class="text-2xl font-bold">R$ 0,00</div>
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-4">
            Fase 2: vamos poder detalhar auditoria, filtros avançados, exportação, etc.
          </p>
        </div>
      </section>
    </main>
  </div>

  <!-- =========================
       MODAL ALUNO (CRUD COMPLETO)
       Ajuste de tamanho/scroll (resolve a caixa que não se ajusta)
       ========================= -->
  <div id="modal-aluno" class="fixed inset-0 hidden z-50 items-center justify-center p-4 bg-black/60">
    <div class="w-full max-w-5xl bg-[#0f172a] border border-gray-700 rounded-2xl shadow-2xl flex flex-col max-h-[calc(100vh-2rem)]">
      <div class="flex items-center justify-between gap-3 p-4 border-b border-gray-700">
        <div>
          <h3 id="modal-aluno-title" class="text-lg font-bold text-white">Novo Aluno</h3>
          <p class="text-xs text-gray-400">Os dados são salvos na unidade selecionada e atualizam em tempo real.</p>
        </div>
        <button id="btn-close-modal-aluno" class="px-3 py-2 rounded-lg bg-[#1f2937] hover:bg-[#334155] text-sm">
          Fechar
        </button>
      </div>

      <!-- área rolável -->
      <div class="p-4 flex-1 overflow-y-auto">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
          <!-- FOTO 3x4 -->
          <div class="lg:col-span-3">
            <div class="bg-[#111827] border border-gray-700 rounded-xl p-3">
              <div class="text-sm font-semibold mb-2">Foto (3x4)</div>

              <div class="w-full aspect-[3/4] bg-[#0b1220] border border-gray-700 rounded-xl overflow-hidden flex items-center justify-center">
                <img id="aluno-foto-preview" alt="Foto 3x4" class="w-full h-full object-cover hidden" />
                <div id="aluno-foto-placeholder" class="text-xs text-gray-400 px-3 text-center">
                  Sem foto. Use “Tirar” ou “Anexar”.
                </div>
              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                <button id="btn-foto-tirar" class="px-3 py-2 rounded-lg bg-[#2563eb] hover:bg-[#1d4ed8] text-white text-sm font-semibold">
                  Tirar
                </button>
                <button id="btn-foto-anexar" class="px-3 py-2 rounded-lg bg-[#334155] hover:bg-[#475569] text-white text-sm font-semibold">
                  Anexar
                </button>
                <button id="btn-foto-remover" class="px-3 py-2 rounded-lg bg-[#7f1d1d] hover:bg-[#991b1b] text-white text-sm font-semibold">
                  Remover
                </button>
              </div>

              <p class="mt-2 text-[11px] text-gray-400">
                Corte automático central (3:4). Se ficar ruim, tire novamente.
              </p>

              <!-- inputs ocultos -->
              <input id="input-foto-camera" type="file" accept="image/*" capture="user" class="hidden" />
              <input id="input-foto-file" type="file" accept="image/*" class="hidden" />
            </div>
          </div>

          <!-- FORM -->
          <div class="lg:col-span-9">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-gray-300">Nome completo *</label>
                <input id="aluno-nome" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="Nome do aluno" />
              </div>

              <div>
                <label class="text-sm text-gray-300">Nascimento</label>
                <input id="aluno-nascimento" type="date" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" />
              </div>

              <div>
                <label class="text-sm text-gray-300">CPF</label>
                <input id="aluno-cpf" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="Somente números ou com pontos/traço" />
              </div>

              <div>
                <label class="text-sm text-gray-300">E-mail</label>
                <input id="aluno-email" type="email" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="email@dominio.com" />
              </div>

              <div>
                <label class="text-sm text-gray-300">Telefone principal</label>
                <input id="aluno-tel1" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="(21) 99999-9999" />
              </div>

              <div>
                <label class="text-sm text-gray-300">Telefone secundário (emergência)</label>
                <input id="aluno-tel2" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="(21) 99999-9999" />
              </div>

              <div class="md:col-span-2">
                <label class="text-sm text-gray-300">Endereço</label>
                <input id="aluno-endereco" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="Rua, número, bairro, cidade" />
              </div>

              <div>
                <label class="text-sm text-gray-300">Status</label>
                <select id="aluno-status" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white">
                  <option value="Ativo">Ativo</option>
                  <option value="Trancado">Trancado</option>
                  <option value="Cancelado">Cancelado</option>
                </select>
              </div>

              <div>
                <label class="text-sm text-gray-300">Desde quando é aluno</label>
                <input id="aluno-desde" type="date" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" />
                <p class="mt-1 text-[11px] text-gray-400">Se vazio, usa a data de criação.</p>
              </div>
            </div>

            <!-- PLANO -->
            <div class="mt-4 bg-[#111827] border border-gray-700 rounded-xl p-3">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold">Plano</div>
                  <div class="text-[11px] text-gray-400">Plano atual + histórico (datas de início/fim).</div>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                <div>
                  <label class="text-sm text-gray-300">Plano atual</label>
                  <input id="plano-atual-nome" class="mt-1 w-full bg-[#0b1220] border border-gray-700 rounded-lg p-2 text-white" placeholder="Ex: Mensal, Trimestral..." />
                </div>
                <div>
                  <label class="text-sm text-gray-300">Início</label>
                  <input id="plano-atual-inicio" type="date" class="mt-1 w-full bg-[#0b1220] border border-gray-700 rounded-lg p-2 text-white" />
                </div>
                <div>
                  <label class="text-sm text-gray-300">Fim</label>
                  <input id="plano-atual-fim" type="date" class="mt-1 w-full bg-[#0b1220] border border-gray-700 rounded-lg p-2 text-white" />
                </div>
              </div>

              <div class="mt-4 flex items-center justify-between">
                <div class="text-sm font-semibold">Histórico de planos</div>
                <button id="btn-add-hist" class="px-3 py-2 rounded-lg bg-[#334155] hover:bg-[#475569] text-white text-sm font-semibold">
                  + Adicionar no histórico
                </button>
              </div>

              <div id="hist-container" class="mt-3 space-y-2"></div>
            </div>

            <!-- DOCUMENTO -->
            <div class="mt-4 bg-[#111827] border border-gray-700 rounded-xl p-3">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold">Documento (foto)</div>
                  <div class="text-[11px] text-gray-400">Para identidade/comprovante. (Imagem comprimida)</div>
                </div>
                <div class="flex flex-wrap gap-2">
                  <button id="btn-doc-tirar" class="px-3 py-2 rounded-lg bg-[#2563eb] hover:bg-[#1d4ed8] text-white text-sm font-semibold">
                    Tirar
                  </button>
                  <button id="btn-doc-anexar" class="px-3 py-2 rounded-lg bg-[#334155] hover:bg-[#475569] text-white text-sm font-semibold">
                    Anexar
                  </button>
                  <button id="btn-doc-remover" class="px-3 py-2 rounded-lg bg-[#7f1d1d] hover:bg-[#991b1b] text-white text-sm font-semibold">
                    Remover
                  </button>
                </div>
              </div>

              <div class="mt-3 flex items-start gap-3">
                <div class="w-28 h-28 bg-[#0b1220] border border-gray-700 rounded-xl overflow-hidden flex items-center justify-center">
                  <img id="aluno-doc-preview" alt="Documento" class="w-full h-full object-cover hidden" />
                  <div id="aluno-doc-placeholder" class="text-[11px] text-gray-400 px-2 text-center">Sem documento</div>
                </div>
                <div class="text-xs text-gray-300">
                  <div id="doc-info" class="text-gray-400">Nenhum documento anexado.</div>
                  <button id="btn-doc-abrir" class="mt-2 px-3 py-2 rounded-lg bg-[#334155] hover:bg-[#475569] text-white text-sm font-semibold hidden">
                    Abrir
                  </button>
                </div>

                <input id="input-doc-camera" type="file" accept="image/*" capture="environment" class="hidden" />
                <input id="input-doc-file" type="file" accept="image/*" class="hidden" />
              </div>
            </div>

            <p id="modal-aluno-error" class="mt-3 text-sm text-red-300 hidden"></p>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-end gap-2 p-4 border-t border-gray-700 bg-[#0b1220] rounded-b-2xl">
        <button id="btn-cancel-modal-aluno" class="px-4 py-2 rounded-lg bg-[#1f2937] hover:bg-[#334155] text-sm">
          Cancelar
        </button>
        <button id="btn-save-aluno" class="px-4 py-2 rounded-lg bg-[#22c55e] hover:bg-[#16a34a] text-white text-sm font-semibold">
          Salvar
        </button>
      </div>
    </div>
  </div>

  <!-- =========================
       MODAL FUNCIONÁRIO (NOVO)
       padrão igual ao aluno: foto 3x4 + documento + dados + salário base + adicional da unidade
       ========================= -->
  <div id="modal-func" class="fixed inset-0 hidden z-50 items-center justify-center p-4 bg-black/60">
    <div class="w-full max-w-5xl bg-[#0f172a] border border-gray-700 rounded-2xl shadow-2xl flex flex-col max-h-[calc(100vh-2rem)]">
      <div class="flex items-center justify-between gap-3 p-4 border-b border-gray-700">
        <div>
          <h3 id="modal-func-title" class="text-lg font-bold text-white">Novo Funcionário</h3>
          <p class="text-xs text-gray-400">Salvo por unidade (base + adicional da unidade). Atualiza em tempo real.</p>
        </div>
        <button id="btn-close-modal-func" class="px-3 py-2 rounded-lg bg-[#1f2937] hover:bg-[#334155] text-sm">
          Fechar
        </button>
      </div>

      <div class="p-4 flex-1 overflow-y-auto">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
          <!-- FOTO 3x4 -->
          <div class="lg:col-span-3">
            <div class="bg-[#111827] border border-gray-700 rounded-xl p-3">
              <div class="text-sm font-semibold mb-2">Foto (3x4)</div>

              <div class="w-full aspect-[3/4] bg-[#0b1220] border border-gray-700 rounded-xl overflow-hidden flex items-center justify-center">
                <img id="func-foto-preview" alt="Foto 3x4" class="w-full h-full object-cover hidden" />
                <div id="func-foto-placeholder" class="text-xs text-gray-400 px-3 text-center">
                  Sem foto. Use “Tirar” ou “Anexar”.
                </div>
              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                <button id="btn-func-foto-tirar" class="px-3 py-2 rounded-lg bg-[#2563eb] hover:bg-[#1d4ed8] text-white text-sm font-semibold">
                  Tirar
                </button>
                <button id="btn-func-foto-anexar" class="px-3 py-2 rounded-lg bg-[#334155] hover:bg-[#475569] text-white text-sm font-semibold">
                  Anexar
                </button>
                <button id="btn-func-foto-remover" class="px-3 py-2 rounded-lg bg-[#7f1d1d] hover:bg-[#991b1b] text-white text-sm font-semibold">
                  Remover
                </button>
              </div>

              <p class="mt-2 text-[11px] text-gray-400">
                Corte automático central (3:4). Se ficar ruim, tire novamente.
              </p>

              <input id="input-func-foto-camera" type="file" accept="image/*" capture="user" class="hidden" />
              <input id="input-func-foto-file" type="file" accept="image/*" class="hidden" />
            </div>
          </div>

          <!-- FORM -->
          <div class="lg:col-span-9">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-gray-300">Nome *</label>
                <input id="func-nome" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="Nome do funcionário" />
              </div>

              <div>
                <label class="text-sm text-gray-300">Cargo *</label>
                <input id="func-cargo" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="Ex: Recepção, Professor..." />
              </div>

              <div>
                <label class="text-sm text-gray-300">Data de contratação</label>
                <input id="func-contratado" type="date" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" />
                <p class="mt-1 text-[11px] text-gray-400">Se vazio, usa a data de criação.</p>
              </div>

              <div>
                <label class="text-sm text-gray-300">CPF</label>
                <input id="func-cpf" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="Somente números ou com pontos/traço" />
              </div>

              <div>
                <label class="text-sm text-gray-300">E-mail</label>
                <input id="func-email" type="email" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="email@dominio.com" />
              </div>

              <div>
                <label class="text-sm text-gray-300">Telefone</label>
                <input id="func-tel1" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="(21) 99999-9999" />
              </div>

              <div class="md:col-span-2">
                <label class="text-sm text-gray-300">Endereço</label>
                <input id="func-endereco" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="Rua, número, bairro, cidade" />
              </div>

              <div>
                <label class="text-sm text-gray-300">Status</label>
                <select id="func-status" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white">
                  <option value="Ativo">Ativo</option>
                  <option value="Afastado">Afastado</option>
                  <option value="Desligado">Desligado</option>
                </select>
              </div>

              <div>
                <label class="text-sm text-gray-300">Salário base (R$)</label>
                <input id="func-salario-base" type="number" step="0.01" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="Ex: 1412" />
              </div>

              <div>
                <label class="text-sm text-gray-300">Adicional desta unidade (R$)</label>
                <input id="func-adicional" type="number" step="0.01" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="Ex: 150" />
                <p class="mt-1 text-[11px] text-gray-400">Ex: salário mínimo + 150 por unidade.</p>
              </div>

              <div>
                <label class="text-sm text-gray-300">Salário total (automático)</label>
                <input id="func-salario-total" disabled class="mt-1 w-full bg-[#0b1220] border border-gray-700 rounded-lg p-2 text-white" />
              </div>

              <div class="md:col-span-2">
                <label class="text-sm text-gray-300">Observações</label>
                <input id="func-obs" class="mt-1 w-full bg-[#111827] border border-gray-700 rounded-lg p-2 text-white" placeholder="Ex: escala, restrições, etc." />
              </div>
            </div>

            <!-- DOCUMENTO -->
            <div class="mt-4 bg-[#111827] border border-gray-700 rounded-xl p-3">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold">Documento (foto)</div>
                  <div class="text-[11px] text-gray-400">Ex: atestado médico, documentos. (Imagem comprimida)</div>
                </div>
                <div class="flex flex-wrap gap-2">
                  <button id="btn-func-doc-tirar" class="px-3 py-2 rounded-lg bg-[#2563eb] hover:bg-[#1d4ed8] text-white text-sm font-semibold">
                    Tirar
                  </button>
                  <button id="btn-func-doc-anexar" class="px-3 py-2 rounded-lg bg-[#334155] hover:bg-[#475569] text-white text-sm font-semibold">
                    Anexar
                  </button>
                  <button id="btn-func-doc-remover" class="px-3 py-2 rounded-lg bg-[#7f1d1d] hover:bg-[#991b1b] text-white text-sm font-semibold">
                    Remover
                  </button>
                </div>
              </div>

              <div class="mt-3 flex items-start gap-3">
                <div class="w-28 h-28 bg-[#0b1220] border border-gray-700 rounded-xl overflow-hidden flex items-center justify-center">
                  <img id="func-doc-preview" alt="Documento" class="w-full h-full object-cover hidden" />
                  <div id="func-doc-placeholder" class="text-[11px] text-gray-400 px-2 text-center">Sem documento</div>
                </div>
                <div class="text-xs text-gray-300">
                  <div id="func-doc-info" class="text-gray-400">Nenhum documento anexado.</div>
                  <button id="btn-func-doc-abrir" class="mt-2 px-3 py-2 rounded-lg bg-[#334155] hover:bg-[#475569] text-white text-sm font-semibold hidden">
                    Abrir
                  </button>
                </div>

                <input id="input-func-doc-camera" type="file" accept="image/*" capture="environment" class="hidden" />
                <input id="input-func-doc-file" type="file" accept="image/*" class="hidden" />
              </div>
            </div>

            <p id="modal-func-error" class="mt-3 text-sm text-red-300 hidden"></p>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-end gap-2 p-4 border-t border-gray-700 bg-[#0b1220] rounded-b-2xl">
        <button id="btn-cancel-modal-func" class="px-4 py-2 rounded-lg bg-[#1f2937] hover:bg-[#334155] text-sm">
          Cancelar
        </button>
        <button id="btn-save-func" class="px-4 py-2 rounded-lg bg-[#22c55e] hover:bg-[#16a34a] text-white text-sm font-semibold">
          Salvar
        </button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIGURAÇÃO FIREBASE
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyBEId876zarlIjEKYUz7ejnLhLcstnsHY7Y",
      authDomain: "sistemadegestaobrabo.firebaseapp.com",
      projectId: "sistemadegestaobrabo",
      storageBucket: "sistemadegestaobrabo.firebasestorage.app",
      messagingSenderId: "1050063988219",
      appId: "1:1050063988219:web:d5a4b3d1305144840675e"
    };

    const allowedEmails = [
      "thiagobrabobm@gmail.com",
      "marlucezanco02@gmail.com"
    ];

    const UNITS = [
      "Academia Zanco - Cordovil",
      "Academia Zanco - Irajá 1",
      "Academia Zanco - Irajá 2",
      "Academia Zanco - Vila da Penha",
      "Academia Zanco - Brás de Pina",
      "Academia Zanco - Caxias"
    ];

    let currentUser = null;
    let selectedUnit = UNITS[0];
    let db, auth;
    let unsubscribers = [];

    const state = {
      planos: [],
      alunos: [],
      funcionarios: [],
      lancamentos: []
    };

    let chartReceitaDespesa = null;
    let chartTopDespesas = null;

    // =========================
    // UTIL
    // =========================
    function formatBRL(value) {
      const n = Number(value || 0);
      return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    const fmtDate = (d) => {
      if (!d) return "--";
      const date = d instanceof Date ? d : new Date(d);
      if (isNaN(date)) return "--";
      return date.toLocaleString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    };

    const fmtDateOnly = (d) => {
      if (!d) return "--";
      const date = d instanceof Date ? d : new Date(d);
      if (isNaN(date)) return "--";
      return date.toLocaleDateString("pt-BR", { day: "2-digit", month: "2-digit", year: "numeric" });
    };

    function showBlocked(message) {
      const loginScreen = document.getElementById("login-screen");
      const appDiv = document.getElementById("app");
      const err = document.getElementById("login-error");

      if (appDiv) appDiv.classList.add("hidden");
      if (loginScreen) loginScreen.classList.remove("hidden");

      if (err) {
        err.textContent = message;
        err.classList.remove("hidden");
      }
    }

    // =========================
    // FIREBASE INIT
    // =========================
    function initFirebase() {
      try {
        if (!firebase.apps || firebase.apps.length === 0) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        auth = firebase.auth();
      } catch (e) {
        console.error("[SGB] Falha ao inicializar Firebase:", e);
        showBlocked("Erro ao inicializar o Firebase. Verifique o console.");
      }
    }

    // =========================
    // EMAIL DA URL
    // =========================
    function getUserEmailFromUrl() {
      try {
        const params = new URLSearchParams(window.location.search || "");
        const email = params.get("userEmail");
        return email ? email.trim().toLowerCase() : null;
      } catch (err) {
        console.error("[SGB] Erro ao ler userEmail da URL:", err);
        return null;
      }
    }

    // =========================
    // AUTH (VIA NEXTAUTH -> query param)
    // =========================
    function setupAuth() {
      const emailFromUrl = getUserEmailFromUrl();

      if (!emailFromUrl) {
        showBlocked("Erro: não foi possível identificar o usuário logado. Saia e faça login novamente.");
        return false;
      }

      if (!allowedEmails.includes(emailFromUrl)) {
        showBlocked("Acesso negado: este e-mail não está autorizado para usar o sistema.");
        return false;
      }

      currentUser = { email: emailFromUrl };

      const userEmailSpan = document.getElementById("user-email");
      if (userEmailSpan) userEmailSpan.textContent = currentUser.email;

      const loginScreen = document.getElementById("login-screen");
      const appDiv = document.getElementById("app");
      if (loginScreen) loginScreen.classList.add("hidden");
      if (appDiv) appDiv.classList.remove("hidden");

      return true;
    }

    // =========================
    // LISTEN FIRESTORE
    // =========================
    function listenUnit(unitId) {
      unsubscribers.forEach((u) => u && u());
      unsubscribers = [];

      state.planos = [];
      state.alunos = [];
      state.funcionarios = [];
      state.lancamentos = [];

      if (!db) return;

      const unitRef = db.collection("unidades").doc(unitId);

      unsubscribers.push(
        unitRef.collection("planos").onSnapshot((snap) => {
          state.planos = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          renderPlanos();
        })
      );

      // Alunos (ordenado por createdAt desc)
      unsubscribers.push(
        unitRef.collection("alunos").orderBy("createdAt", "desc").onSnapshot((snap) => {
          state.alunos = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          renderAlunos();
        })
      );

      // Funcionários (sem orderBy para não quebrar docs antigos sem createdAt)
      unsubscribers.push(
        unitRef.collection("funcionarios").onSnapshot((snap) => {
          state.funcionarios = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          renderFuncionarios();
        })
      );

      unsubscribers.push(
        unitRef.collection("lancamentos")
          .orderBy("dataVencimento", "desc")
          .onSnapshot((snap) => {
            state.lancamentos = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
            renderLancamentos();
            updateKPIsAndCharts();
          })
      );
    }

    // =========================
    // UI
    // =========================
    function renderUnitsSelector() {
      const sel = document.getElementById("unit-selector");
      if (!sel) return;

      sel.innerHTML = "";
      UNITS.forEach((u) => {
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        if (u === selectedUnit) opt.selected = true;
        sel.appendChild(opt);
      });

      sel.addEventListener("change", (e) => {
        selectedUnit = e.target.value;
        listenUnit(selectedUnit);
      });
    }

    function renderAlunos() {
      const tbody = document.getElementById("table-alunos");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (state.alunos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="p-2 text-gray-400">Nenhum aluno cadastrado.</td></tr>`;
        return;
      }

      state.alunos.forEach((a) => {
        const createdAt = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : a.createdAt) : null;
        const desde = a.desde ? new Date(a.desde) : createdAt;

        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700 hover:bg-gray-700/40";

        const tdNome = document.createElement("td");
        tdNome.className = "p-2";
        tdNome.textContent = a.nome_completo || "--";

        const tdEmail = document.createElement("td");
        tdEmail.className = "p-2";
        tdEmail.textContent = a.email || "--";

        const tdStatus = document.createElement("td");
        tdStatus.className = "p-2";
        tdStatus.textContent = a.status_aluno || "Ativo";

        const tdDesde = document.createElement("td");
        tdDesde.className = "p-2";
        tdDesde.textContent = desde ? fmtDateOnly(desde) : "--";

        const tdCriado = document.createElement("td");
        tdCriado.className = "p-2 text-xs text-gray-300";
        tdCriado.textContent = `${a.createdBy || "--"} ${createdAt ? "(" + fmtDate(createdAt) + ")" : ""}`;

        const tdAcoes = document.createElement("td");
        tdAcoes.className = "p-2 text-right";
        const wrap = document.createElement("div");
        wrap.className = "inline-flex gap-2";

        const btnEdit = document.createElement("button");
        btnEdit.className = "px-3 py-2 rounded-lg bg-[#334155] hover:bg-[#475569] text-white text-xs font-semibold";
        btnEdit.textContent = "Editar";
        btnEdit.addEventListener("click", () => openAlunoModal("edit", a));

        const btnDel = document.createElement("button");
        btnDel.className = "px-3 py-2 rounded-lg bg-[#7f1d1d] hover:bg-[#991b1b] text-white text-xs font-semibold";
        btnDel.textContent = "Excluir";
        btnDel.addEventListener("click", () => deleteAluno(a));

        wrap.appendChild(btnEdit);
        wrap.appendChild(btnDel);
        tdAcoes.appendChild(wrap);

        tr.appendChild(tdNome);
        tr.appendChild(tdEmail);
        tr.appendChild(tdStatus);
        tr.appendChild(tdDesde);
        tr.appendChild(tdCriado);
        tr.appendChild(tdAcoes);

        tbody.appendChild(tr);
      });
    }

    function renderFuncionarios() {
      const tbody = document.getElementById("table-funcionarios");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (state.funcionarios.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="p-2 text-gray-400">Nenhum funcionário cadastrado.</td></tr>`;
        return;
      }

      state.funcionarios.forEach((f) => {
        const createdAt = f.createdAt ? (f.createdAt.toDate ? f.createdAt.toDate() : f.createdAt) : null;
        const desde = f.contratadoEm ? new Date(f.contratadoEm) : createdAt;

        const base = Number(f.salario_base || 0);
        const adicional = Number(f.adicional_unidade || 0);
        const total = base + adicional;

        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700 hover:bg-gray-700/40";

        const tdNome = document.createElement("td");
        tdNome.className = "p-2";
        tdNome.textContent = f.nome || "--";

        const tdCargo = document.createElement("td");
        tdCargo.className = "p-2";
        tdCargo.textContent = f.cargo || "--";

        const tdDesde = document.createElement("td");
        tdDesde.className = "p-2";
        tdDesde.textContent = desde ? fmtDateOnly(desde) : "--";

        const tdSal = document.createElement("td");
        tdSal.className = "p-2 text-right";
        tdSal.innerHTML = `
          <div class="font-semibold">${formatBRL(total)}</div>
          <div class="text-[11px] text-gray-400">${formatBRL(base)} + ${formatBRL(adicional)}</div>
        `;

        const tdCriado = document.createElement("td");
        tdCriado.className = "p-2 text-xs text-gray-300";
        tdCriado.textContent = `${f.createdBy || "--"} ${createdAt ? "(" + fmtDate(createdAt) + ")" : ""}`;

        const tdAcoes = document.createElement("td");
        tdAcoes.className = "p-2 text-right";
        const wrap = document.createElement("div");
        wrap.className = "inline-flex gap-2";

        const btnEdit = document.createElement("button");
        btnEdit.className = "px-3 py-2 rounded-lg bg-[#334155] hover:bg-[#475569] text-white text-xs font-semibold";
        btnEdit.textContent = "Editar";
        btnEdit.addEventListener("click", () => openFuncModal("edit", f));

        const btnDel = document.createElement("button");
        btnDel.className = "px-3 py-2 rounded-lg bg-[#7f1d1d] hover:bg-[#991b1b] text-white text-xs font-semibold";
        btnDel.textContent = "Excluir";
        btnDel.addEventListener("click", () => deleteFuncionario(f));

        wrap.appendChild(btnEdit);
        wrap.appendChild(btnDel);
        tdAcoes.appendChild(wrap);

        tr.appendChild(tdNome);
        tr.appendChild(tdCargo);
        tr.appendChild(tdDesde);
        tr.appendChild(tdSal);
        tr.appendChild(tdCriado);
        tr.appendChild(tdAcoes);

        tbody.appendChild(tr);
      });
    }

    function renderPlanos() {
      const tbody = document.getElementById("table-planos");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (state.planos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-2 text-gray-400">Nenhum plano cadastrado.</td></tr>`;
        return;
      }

      state.planos.forEach((p) => {
        const createdAt = p.createdAt ? (p.createdAt.toDate ? p.createdAt.toDate() : p.createdAt) : null;
        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700 hover:bg-gray-700/40";
        tr.innerHTML = `
          <td class="p-2">${p.nome_plano || "--"}</td>
          <td class="p-2 text-right">${formatBRL(p.valor)}</td>
          <td class="p-2">${p.status_plano || "Ativo"}</td>
          <td class="p-2 text-xs text-gray-300">${p.createdBy || "--"} ${createdAt ? "(" + fmtDate(createdAt) + ")" : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderLancamentos() {
      const tbody = document.getElementById("table-lancamentos");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (state.lancamentos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="p-2 text-gray-400">Nenhum lançamento cadastrado.</td></tr>`;
        return;
      }

      state.lancamentos.forEach((l) => {
        const createdAt = l.createdAt ? (l.createdAt.toDate ? l.createdAt.toDate() : l.createdAt) : null;

        const valor = Number(l.valor || 0);
        const tipo = l.tipo || "DESPESA";
        const sinal = tipo === "DESPESA" ? "-" : "+";
        const valorClass = tipo === "DESPESA" ? "text-red-300" : "text-green-300";

        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700 hover:bg-gray-700/40";
        tr.innerHTML = `
          <td class="p-2">${l.descricao || "--"}</td>
          <td class="p-2">${l.categoria || "--"}</td>
          <td class="p-2">${tipo}</td>
          <td class="p-2 text-right ${valorClass}">${sinal} ${formatBRL(valor)}</td>
          <td class="p-2">${l.dataVencimento || "--"}</td>
          <td class="p-2 text-xs text-gray-300">${l.createdBy || "--"} ${createdAt ? "(" + fmtDate(createdAt) + ")" : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // =========================
    // KPIs & CHARTS
    // =========================
    function updateKPIsAndCharts() {
      const receitaTotal = state.lancamentos
        .filter((l) => l.tipo === "RECEITA")
        .reduce((acc, l) => acc + Number(l.valor || 0), 0);

      const custoTotal = state.lancamentos
        .filter((l) => l.tipo === "DESPESA")
        .reduce((acc, l) => acc + Number(l.valor || 0), 0);

      const saldo = receitaTotal - custoTotal;

      const kpiReceita = document.getElementById("kpi-receita");
      const kpiCusto = document.getElementById("kpi-custo");
      const kpiSaldo = document.getElementById("kpi-saldo");

      const relReceita = document.getElementById("rel-receita");
      const relCusto = document.getElementById("rel-custo");
      const relSaldo = document.getElementById("rel-saldo");

      if (kpiReceita) kpiReceita.textContent = formatBRL(receitaTotal);
      if (kpiCusto) kpiCusto.textContent = formatBRL(custoTotal);
      if (kpiSaldo) kpiSaldo.textContent = formatBRL(saldo);

      if (relReceita) relReceita.textContent = formatBRL(receitaTotal);
      if (relCusto) relCusto.textContent = formatBRL(custoTotal);
      if (relSaldo) relSaldo.textContent = formatBRL(saldo);

      const canvas1 = document.getElementById("chart-receita-despesa");
      if (canvas1) {
        const ctx1 = canvas1.getContext("2d");
        if (chartReceitaDespesa) chartReceitaDespesa.destroy();
        chartReceitaDespesa = new Chart(ctx1, {
          type: "bar",
          data: {
            labels: ["Mês Atual"],
            datasets: [
              { label: "Receita", data: [receitaTotal], backgroundColor: "rgba(72, 187, 120, 0.7)" },
              { label: "Despesas", data: [custoTotal], backgroundColor: "rgba(245, 101, 101, 0.7)" }
            ]
          },
          options: { responsive: true }
        });
      }

      const despesasGrouped = {};
      state.lancamentos
        .filter((l) => l.tipo === "DESPESA")
        .forEach((l) => {
          const cat = l.categoria || "Outras";
          despesasGrouped[cat] = (despesasGrouped[cat] || 0) + Number(l.valor || 0);
        });

      const top = Object.entries(despesasGrouped)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      const canvas2 = document.getElementById("chart-despesas-top");
      if (canvas2) {
        const ctx2 = canvas2.getContext("2d");
        if (chartTopDespesas) chartTopDespesas.destroy();
        chartTopDespesas = new Chart(ctx2, {
          type: "doughnut",
          data: {
            labels: top.map(([k]) => k),
            datasets: [{ data: top.map(([, v]) => v) }]
          },
          options: { responsive: true }
        });
      }
    }

    // =========================
    // CRUD SIMPLES (PLANOS/LANÇAMENTOS)
    // =========================
    function getUnitRef() {
      return db.collection("unidades").doc(selectedUnit);
    }

    async function addPlanoPrompt() {
      if (!currentUser?.email) return alert("Faça login antes.");
      const nome = prompt("Nome do plano:");
      if (!nome) return;
      const valorStr = prompt("Valor (R$):", "0");
      const valor = Number(valorStr || "0");

      await getUnitRef().collection("planos").add({
        nome_plano: nome,
        valor,
        status_plano: "Ativo",
        createdBy: currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser.email,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Plano criado com sucesso.");
    }

    async function addLancamentoPrompt() {
      if (!currentUser?.email) return alert("Faça login antes.");
      const tipo = (prompt("Tipo (DESPESA ou RECEITA):", "DESPESA") || "").toUpperCase();
      if (!["DESPESA", "RECEITA"].includes(tipo)) return alert("Tipo inválido.");

      const descricao = prompt("Descrição do lançamento:");
      if (!descricao) return;
      const categoria = prompt("Categoria:");
      if (!categoria) return;

      const valStr = prompt("Valor (R$):", "0");
      const valor = Number(valStr || "0");
      const venc = prompt("Data de vencimento (YYYY-MM-DD):", new Date().toISOString().slice(0, 10));
      if (!venc) return;

      await getUnitRef().collection("lancamentos").add({
        tipo,
        descricao,
        categoria,
        valor,
        dataVencimento: venc,
        dataPagamento: null,
        createdBy: currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser.email,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Lançamento criado com sucesso.");
    }

    // =========================
    // ALUNOS - MODAL COMPLETO (seu)
    // =========================
    function showModalError(msg) {
      const el = document.getElementById("modal-aluno-error");
      if (!el) return;
      el.textContent = msg;
      el.classList.remove("hidden");
    }
    function clearModalError() {
      const el = document.getElementById("modal-aluno-error");
      if (!el) return;
      el.textContent = "";
      el.classList.add("hidden");
    }

    let alunoModalMode = "new";      // "new" | "edit"
    let alunoEditingId = null;
    let alunoFotoDataUrl = null;
    let alunoDocDataUrl = null;
    let histItems = []; // array de {nome, inicio, fim}

    const LIMIT_PHOTO_MAX_SIDE = 480;   // foto 3x4 leve
    const LIMIT_DOC_MAX_SIDE = 1280;    // documento legível, ainda leve
    const MAX_DATAURL_CHARS = 850000;   // margem pra não estourar 1MB do Firestore

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }
    function escapeAttr(str) {
      return String(str || "").replace(/"/g, "&quot;");
    }

    function openAlunoModal(mode, aluno = null) {
      clearModalError();

      alunoModalMode = mode;
      alunoEditingId = aluno?.id || null;

      document.getElementById("modal-aluno-title").textContent = mode === "edit" ? "Editar Aluno" : "Novo Aluno";

      alunoFotoDataUrl = null;
      alunoDocDataUrl = null;
      histItems = [];

      setFotoPreview(null);
      setDocPreview(null);

      document.getElementById("aluno-nome").value = aluno?.nome_completo || "";
      document.getElementById("aluno-nascimento").value = aluno?.nascimento || "";
      document.getElementById("aluno-cpf").value = aluno?.cpf || "";
      document.getElementById("aluno-endereco").value = aluno?.endereco || "";
      document.getElementById("aluno-email").value = aluno?.email || "";
      document.getElementById("aluno-tel1").value = aluno?.tel_principal || "";
      document.getElementById("aluno-tel2").value = aluno?.tel_secundario || "";
      document.getElementById("aluno-status").value = aluno?.status_aluno || "Ativo";
      document.getElementById("aluno-desde").value = aluno?.desde || "";

      document.getElementById("plano-atual-nome").value = aluno?.planoAtual?.nome || "";
      document.getElementById("plano-atual-inicio").value = aluno?.planoAtual?.inicio || "";
      document.getElementById("plano-atual-fim").value = aluno?.planoAtual?.fim || "";

      const incomingHist = Array.isArray(aluno?.planosHistorico) ? aluno.planosHistorico : [];
      histItems = incomingHist.map(x => ({
        nome: x?.nome || "",
        inicio: x?.inicio || "",
        fim: x?.fim || ""
      }));
      renderHist();

      if (aluno?.foto3x4 && typeof aluno.foto3x4 === "string") {
        alunoFotoDataUrl = aluno.foto3x4;
        setFotoPreview(alunoFotoDataUrl);
      }
      if (aluno?.docImagem && typeof aluno.docImagem === "string") {
        alunoDocDataUrl = aluno.docImagem;
        setDocPreview(alunoDocDataUrl);
      }

      const modal = document.getElementById("modal-aluno");
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    function closeAlunoModal() {
      const modal = document.getElementById("modal-aluno");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    function setFotoPreview(dataUrl) {
      const img = document.getElementById("aluno-foto-preview");
      const ph = document.getElementById("aluno-foto-placeholder");
      if (!dataUrl) {
        img.classList.add("hidden");
        img.src = "";
        ph.classList.remove("hidden");
        return;
      }
      img.src = dataUrl;
      img.classList.remove("hidden");
      ph.classList.add("hidden");
    }

    function setDocPreview(dataUrl) {
      const img = document.getElementById("aluno-doc-preview");
      const ph = document.getElementById("aluno-doc-placeholder");
      const info = document.getElementById("doc-info");
      const btnAbrir = document.getElementById("btn-doc-abrir");

      if (!dataUrl) {
        img.classList.add("hidden");
        img.src = "";
        ph.classList.remove("hidden");
        info.textContent = "Nenhum documento anexado.";
        btnAbrir.classList.add("hidden");
        return;
      }

      img.src = dataUrl;
      img.classList.remove("hidden");
      ph.classList.add("hidden");
      info.textContent = "Documento anexado.";
      btnAbrir.classList.remove("hidden");

      btnAbrir.onclick = () => {
        const w = window.open();
        if (!w) return;
        w.document.write(`<img src="${dataUrl}" style="max-width:100%;height:auto;" />`);
      };
    }

    function renderHist() {
      const box = document.getElementById("hist-container");
      box.innerHTML = "";

      if (histItems.length === 0) {
        const empty = document.createElement("div");
        empty.className = "text-xs text-gray-400";
        empty.textContent = "Nenhum histórico adicionado.";
        box.appendChild(empty);
        return;
      }

      histItems.forEach((item, idx) => {
        const row = document.createElement("div");
        row.className = "grid grid-cols-1 md:grid-cols-12 gap-2 bg-[#0b1220] border border-gray-700 rounded-lg p-2";

        const c1 = document.createElement("div");
        c1.className = "md:col-span-6";
        c1.innerHTML = `
          <label class="text-[11px] text-gray-400">Plano</label>
          <input data-hist="nome" data-idx="${idx}" class="mt-1 w-full bg-[#0b1220] border border-gray-700 rounded-lg p-2 text-white" placeholder="Nome do plano" value="${escapeHtml(item.nome)}" />
        `;

        const c2 = document.createElement("div");
        c2.className = "md:col-span-2";
        c2.innerHTML = `
          <label class="text-[11px] text-gray-400">Início</label>
          <input data-hist="inicio" data-idx="${idx}" type="date" class="mt-1 w-full bg-[#0b1220] border border-gray-700 rounded-lg p-2 text-white" value="${escapeAttr(item.inicio)}" />
        `;

        const c3 = document.createElement("div");
        c3.className = "md:col-span-2";
        c3.innerHTML = `
          <label class="text-[11px] text-gray-400">Fim</label>
          <input data-hist="fim" data-idx="${idx}" type="date" class="mt-1 w-full bg-[#0b1220] border border-gray-700 rounded-lg p-2 text-white" value="${escapeAttr(item.fim)}" />
        `;

        const c4 = document.createElement("div");
        c4.className = "md:col-span-2 flex items-end justify-end";
        const btn = document.createElement("button");
        btn.className = "w-full md:w-auto px-3 py-2 rounded-lg bg-[#7f1d1d] hover:bg-[#991b1b] text-white text-sm font-semibold";
        btn.textContent = "Remover";
        btn.addEventListener("click", () => {
          histItems.splice(idx, 1);
          renderHist();
        });
        c4.appendChild(btn);

        row.appendChild(c1);
        row.appendChild(c2);
        row.appendChild(c3);
        row.appendChild(c4);

        box.appendChild(row);
      });

      box.querySelectorAll("input[data-hist]").forEach((inp) => {
        inp.addEventListener("input", (e) => {
          const idx = Number(e.target.getAttribute("data-idx"));
          const key = e.target.getAttribute("data-hist");
          histItems[idx][key] = e.target.value;
        });
      });
    }

    async function saveAlunoFromModal() {
      clearModalError();

      if (!currentUser?.email) {
        showModalError("Você não está logado.");
        return;
      }

      const nome = document.getElementById("aluno-nome").value.trim();
      if (!nome) {
        showModalError("Nome completo é obrigatório.");
        return;
      }

      const payload = {
        nome_completo: nome,
        nascimento: document.getElementById("aluno-nascimento").value || "",
        cpf: document.getElementById("aluno-cpf").value.trim() || "",
        endereco: document.getElementById("aluno-endereco").value.trim() || "",
        email: (document.getElementById("aluno-email").value || "").trim(),
        tel_principal: document.getElementById("aluno-tel1").value.trim() || "",
        tel_secundario: document.getElementById("aluno-tel2").value.trim() || "",
        status_aluno: document.getElementById("aluno-status").value || "Ativo",
        desde: document.getElementById("aluno-desde").value || "",

        planoAtual: {
          nome: document.getElementById("plano-atual-nome").value.trim() || "",
          inicio: document.getElementById("plano-atual-inicio").value || "",
          fim: document.getElementById("plano-atual-fim").value || ""
        },

        planosHistorico: histItems
          .map(x => ({ nome: (x.nome || "").trim(), inicio: x.inicio || "", fim: x.fim || "" }))
          .filter(x => x.nome || x.inicio || x.fim),

        foto3x4: alunoFotoDataUrl || "",
        docImagem: alunoDocDataUrl || ""
      };

      if ((payload.foto3x4 && payload.foto3x4.length > MAX_DATAURL_CHARS) ||
          (payload.docImagem && payload.docImagem.length > MAX_DATAURL_CHARS)) {
        showModalError("Imagem muito grande. Tente anexar novamente (ou use uma foto com menor resolução).");
        return;
      }

      const col = getUnitRef().collection("alunos");

      try {
        if (alunoModalMode === "new") {
          await col.add({
            ...payload,
            createdBy: currentUser.email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser.email,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          if (!alunoEditingId) {
            showModalError("Erro interno: alunoEditingId ausente.");
            return;
          }
          await col.doc(alunoEditingId).update({
            ...payload,
            updatedBy: currentUser.email,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        closeAlunoModal();
      } catch (err) {
        console.error("[SGB] Erro ao salvar aluno:", err);
        showModalError("Erro ao salvar. Veja o console.");
      }
    }

    async function deleteAluno(aluno) {
      if (!currentUser?.email) return alert("Faça login antes.");
      if (!aluno?.id) return;

      const ok = confirm(`Excluir o aluno "${aluno.nome_completo || ""}"? Isso não pode ser desfeito.`);
      if (!ok) return;

      try {
        await getUnitRef().collection("alunos").doc(aluno.id).delete();
      } catch (err) {
        console.error("[SGB] Erro ao excluir aluno:", err);
        alert("Erro ao excluir. Veja o console.");
      }
    }

    // =========================
    // FUNCIONÁRIOS - MODAL (NOVO)
    // =========================
    function showFuncError(msg) {
      const el = document.getElementById("modal-func-error");
      if (!el) return;
      el.textContent = msg;
      el.classList.remove("hidden");
    }
    function clearFuncError() {
      const el = document.getElementById("modal-func-error");
      if (!el) return;
      el.textContent = "";
      el.classList.add("hidden");
    }

    let funcModalMode = "new"; // "new" | "edit"
    let funcEditingId = null;
    let funcFotoDataUrl = null;
    let funcDocDataUrl = null;

    function openFuncModal(mode, func = null) {
      clearFuncError();

      funcModalMode = mode;
      funcEditingId = func?.id || null;

      document.getElementById("modal-func-title").textContent = mode === "edit" ? "Editar Funcionário" : "Novo Funcionário";

      funcFotoDataUrl = null;
      funcDocDataUrl = null;

      setFuncFotoPreview(null);
      setFuncDocPreview(null);

      document.getElementById("func-nome").value = func?.nome || "";
      document.getElementById("func-cargo").value = func?.cargo || "";
      document.getElementById("func-contratado").value = func?.contratadoEm || "";
      document.getElementById("func-cpf").value = func?.cpf || "";
      document.getElementById("func-email").value = func?.email || "";
      document.getElementById("func-tel1").value = func?.tel_principal || "";
      document.getElementById("func-endereco").value = func?.endereco || "";
      document.getElementById("func-status").value = func?.status_funcionario || "Ativo";

      document.getElementById("func-salario-base").value = (func?.salario_base ?? "");
      document.getElementById("func-adicional").value = (func?.adicional_unidade ?? "");
      document.getElementById("func-obs").value = func?.obs || "";

      updateFuncSalarioTotal();

      if (func?.foto3x4 && typeof func.foto3x4 === "string") {
        funcFotoDataUrl = func.foto3x4;
        setFuncFotoPreview(funcFotoDataUrl);
      }
      if (func?.docImagem && typeof func.docImagem === "string") {
        funcDocDataUrl = func.docImagem;
        setFuncDocPreview(funcDocDataUrl);
      }

      const modal = document.getElementById("modal-func");
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    function closeFuncModal() {
      const modal = document.getElementById("modal-func");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    function setFuncFotoPreview(dataUrl) {
      const img = document.getElementById("func-foto-preview");
      const ph = document.getElementById("func-foto-placeholder");
      if (!dataUrl) {
        img.classList.add("hidden");
        img.src = "";
        ph.classList.remove("hidden");
        return;
      }
      img.src = dataUrl;
      img.classList.remove("hidden");
      ph.classList.add("hidden");
    }

    function setFuncDocPreview(dataUrl) {
      const img = document.getElementById("func-doc-preview");
      const ph = document.getElementById("func-doc-placeholder");
      const info = document.getElementById("func-doc-info");
      const btnAbrir = document.getElementById("btn-func-doc-abrir");

      if (!dataUrl) {
        img.classList.add("hidden");
        img.src = "";
        ph.classList.remove("hidden");
        info.textContent = "Nenhum documento anexado.";
        btnAbrir.classList.add("hidden");
        return;
      }

      img.src = dataUrl;
      img.classList.remove("hidden");
      ph.classList.add("hidden");
      info.textContent = "Documento anexado.";
      btnAbrir.classList.remove("hidden");

      btnAbrir.onclick = () => {
        const w = window.open();
        if (!w) return;
        w.document.write(`<img src="${dataUrl}" style="max-width:100%;height:auto;" />`);
      };
    }

    function updateFuncSalarioTotal() {
      const base = Number(document.getElementById("func-salario-base").value || 0);
      const add = Number(document.getElementById("func-adicional").value || 0);
      document.getElementById("func-salario-total").value = formatBRL(base + add);
    }

    async function saveFuncionarioFromModal() {
      clearFuncError();

      if (!currentUser?.email) {
        showFuncError("Você não está logado.");
        return;
      }

      const nome = document.getElementById("func-nome").value.trim();
      const cargo = document.getElementById("func-cargo").value.trim();
      if (!nome) return showFuncError("Nome é obrigatório.");
      if (!cargo) return showFuncError("Cargo é obrigatório.");

      const salarioBase = Number(document.getElementById("func-salario-base").value || 0);
      const adicional = Number(document.getElementById("func-adicional").value || 0);

      const payload = {
        nome,
        cargo,
        contratadoEm: document.getElementById("func-contratado").value || "",
        cpf: document.getElementById("func-cpf").value.trim() || "",
        email: (document.getElementById("func-email").value || "").trim(),
        tel_principal: document.getElementById("func-tel1").value.trim() || "",
        endereco: document.getElementById("func-endereco").value.trim() || "",
        status_funcionario: document.getElementById("func-status").value || "Ativo",
        salario_base: salarioBase,
        adicional_unidade: adicional,
        obs: document.getElementById("func-obs").value.trim() || "",
        foto3x4: funcFotoDataUrl || "",
        docImagem: funcDocDataUrl || ""
      };

      if ((payload.foto3x4 && payload.foto3x4.length > MAX_DATAURL_CHARS) ||
          (payload.docImagem && payload.docImagem.length > MAX_DATAURL_CHARS)) {
        showFuncError("Imagem muito grande. Tente anexar novamente com menor resolução.");
        return;
      }

      const col = getUnitRef().collection("funcionarios");

      try {
        if (funcModalMode === "new") {
          await col.add({
            ...payload,
            createdBy: currentUser.email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser.email,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          if (!funcEditingId) return showFuncError("Erro interno: funcEditingId ausente.");
          await col.doc(funcEditingId).update({
            ...payload,
            updatedBy: currentUser.email,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        closeFuncModal();
      } catch (err) {
        console.error("[SGB] Erro ao salvar funcionário:", err);
        showFuncError("Erro ao salvar. Veja o console.");
      }
    }

    async function deleteFuncionario(func) {
      if (!currentUser?.email) return alert("Faça login antes.");
      if (!func?.id) return;

      const ok = confirm(`Excluir o funcionário "${func.nome || ""}"? Isso não pode ser desfeito.`);
      if (!ok) return;

      try {
        await getUnitRef().collection("funcionarios").doc(func.id).delete();
      } catch (err) {
        console.error("[SGB] Erro ao excluir funcionário:", err);
        alert("Erro ao excluir. Veja o console.");
      }
    }

    // =========================
    // IMAGENS (reuso: aluno e func)
    // =========================
    function readFileAsImage(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = fr.result;
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function canvasToJpegDataUrl(canvas, quality = 0.85) {
      return canvas.toDataURL("image/jpeg", quality);
    }

    function centerCropToRatio(img, targetW, targetH, ratioW, ratioH) {
      const srcW = img.naturalWidth;
      const srcH = img.naturalHeight;

      const targetRatio = ratioW / ratioH;
      const srcRatio = srcW / srcH;

      let cropW, cropH;
      if (srcRatio > targetRatio) {
        cropH = srcH;
        cropW = Math.floor(srcH * targetRatio);
      } else {
        cropW = srcW;
        cropH = Math.floor(srcW / targetRatio);
      }

      const sx = Math.floor((srcW - cropW) / 2);
      const sy = Math.floor((srcH - cropH) / 2);

      const canvas = document.createElement("canvas");
      canvas.width = targetW;
      canvas.height = targetH;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, sx, sy, cropW, cropH, 0, 0, targetW, targetH);

      return canvas;
    }

    function resizeKeepAspect(img, maxSide) {
      const srcW = img.naturalWidth;
      const srcH = img.naturalHeight;

      let outW = srcW;
      let outH = srcH;

      const maxSrc = Math.max(srcW, srcH);
      if (maxSrc > maxSide) {
        const scale = maxSide / maxSrc;
        outW = Math.round(srcW * scale);
        outH = Math.round(srcH * scale);
      }

      const canvas = document.createElement("canvas");
      canvas.width = outW;
      canvas.height = outH;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, outW, outH);
      return canvas;
    }

    async function handleFotoFile(file, onDone) {
      try {
        const img = await readFileAsImage(file);
        const canvas = centerCropToRatio(img, 360, 480, 3, 4);
        const dataUrl = canvasToJpegDataUrl(canvas, 0.85);

        if (dataUrl.length > MAX_DATAURL_CHARS) {
          alert("A foto ficou grande demais. Tente outra (menor) ou tire novamente.");
          return;
        }

        onDone(dataUrl);
      } catch (e) {
        console.error(e);
        alert("Falha ao processar a foto.");
      }
    }

    async function handleDocFile(file, onDone) {
      try {
        const img = await readFileAsImage(file);
        const canvas = resizeKeepAspect(img, LIMIT_DOC_MAX_SIDE);
        const dataUrl = canvasToJpegDataUrl(canvas, 0.78);

        if (dataUrl.length > MAX_DATAURL_CHARS) {
          alert("O documento ficou grande demais. Tente outra foto (mais leve).");
          return;
        }

        onDone(dataUrl);
      } catch (e) {
        console.error(e);
        alert("Falha ao processar o documento.");
      }
    }

    // =========================
    // ABAS
    // =========================
    function setupTabs() {
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.getAttribute("data-tab");

          tabButtons.forEach((b) => {
            b.classList.remove("tab-active");
            b.classList.add("tab-inactive");
          });
          btn.classList.remove("tab-inactive");
          btn.classList.add("tab-active");

          tabContents.forEach((section) => {
            if (section.id === "tab-" + tab) section.classList.remove("hidden");
            else section.classList.add("hidden");
          });
        });
      });
    }

    // =========================
    // START
    // =========================
    document.addEventListener("DOMContentLoaded", () => {
      initFirebase();

      const ok = setupAuth();
      if (!ok) return;

      setupTabs();
      renderUnitsSelector();
      listenUnit(selectedUnit);

      document.getElementById("btn-add-plano")?.addEventListener("click", addPlanoPrompt);
      document.getElementById("btn-add-lancamento")?.addEventListener("click", addLancamentoPrompt);

      // ====== Alunos (modal)
      document.getElementById("btn-add-aluno")?.addEventListener("click", () => openAlunoModal("new"));

      document.getElementById("btn-close-modal-aluno")?.addEventListener("click", closeAlunoModal);
      document.getElementById("btn-cancel-modal-aluno")?.addEventListener("click", closeAlunoModal);
      document.getElementById("btn-save-aluno")?.addEventListener("click", saveAlunoFromModal);

      document.getElementById("btn-add-hist")?.addEventListener("click", () => {
        histItems.push({ nome: "", inicio: "", fim: "" });
        renderHist();
      });

      // Foto aluno
      const inputFotoCam = document.getElementById("input-foto-camera");
      const inputFotoFile = document.getElementById("input-foto-file");
      document.getElementById("btn-foto-tirar")?.addEventListener("click", () => inputFotoCam.click());
      document.getElementById("btn-foto-anexar")?.addEventListener("click", () => inputFotoFile.click());
      document.getElementById("btn-foto-remover")?.addEventListener("click", () => {
        alunoFotoDataUrl = null;
        setFotoPreview(null);
      });

      inputFotoCam?.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        e.target.value = "";
        if (f) handleFotoFile(f, (dataUrl) => { alunoFotoDataUrl = dataUrl; setFotoPreview(dataUrl); });
      });
      inputFotoFile?.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        e.target.value = "";
        if (f) handleFotoFile(f, (dataUrl) => { alunoFotoDataUrl = dataUrl; setFotoPreview(dataUrl); });
      });

      // Doc aluno
      const inputDocCam = document.getElementById("input-doc-camera");
      const inputDocFile = document.getElementById("input-doc-file");
      document.getElementById("btn-doc-tirar")?.addEventListener("click", () => inputDocCam.click());
      document.getElementById("btn-doc-anexar")?.addEventListener("click", () => inputDocFile.click());
      document.getElementById("btn-doc-remover")?.addEventListener("click", () => {
        alunoDocDataUrl = null;
        setDocPreview(null);
      });

      inputDocCam?.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        e.target.value = "";
        if (f) handleDocFile(f, (dataUrl) => { alunoDocDataUrl = dataUrl; setDocPreview(dataUrl); });
      });
      inputDocFile?.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        e.target.value = "";
        if (f) handleDocFile(f, (dataUrl) => { alunoDocDataUrl = dataUrl; setDocPreview(dataUrl); });
      });

      // Fecha modal aluno clicando fora
      document.getElementById("modal-aluno")?.addEventListener("click", (e) => {
        if (e.target.id === "modal-aluno") closeAlunoModal();
      });

      // ====== Funcionários (modal novo)
      document.getElementById("btn-add-funcionario")?.addEventListener("click", () => openFuncModal("new"));

      document.getElementById("btn-close-modal-func")?.addEventListener("click", closeFuncModal);
      document.getElementById("btn-cancel-modal-func")?.addEventListener("click", closeFuncModal);
      document.getElementById("btn-save-func")?.addEventListener("click", saveFuncionarioFromModal);

      // salário total automático
      document.getElementById("func-salario-base")?.addEventListener("input", updateFuncSalarioTotal);
      document.getElementById("func-adicional")?.addEventListener("input", updateFuncSalarioTotal);

      // Foto func
      const inputFuncFotoCam = document.getElementById("input-func-foto-camera");
      const inputFuncFotoFile = document.getElementById("input-func-foto-file");
      document.getElementById("btn-func-foto-tirar")?.addEventListener("click", () => inputFuncFotoCam.click());
      document.getElementById("btn-func-foto-anexar")?.addEventListener("click", () => inputFuncFotoFile.click());
      document.getElementById("btn-func-foto-remover")?.addEventListener("click", () => {
        funcFotoDataUrl = null;
        setFuncFotoPreview(null);
      });

      inputFuncFotoCam?.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        e.target.value = "";
        if (f) handleFotoFile(f, (dataUrl) => { funcFotoDataUrl = dataUrl; setFuncFotoPreview(dataUrl); });
      });
      inputFuncFotoFile?.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        e.target.value = "";
        if (f) handleFotoFile(f, (dataUrl) => { funcFotoDataUrl = dataUrl; setFuncFotoPreview(dataUrl); });
      });

      // Doc func
      const inputFuncDocCam = document.getElementById("input-func-doc-camera");
      const inputFuncDocFile = document.getElementById("input-func-doc-file");
      document.getElementById("btn-func-doc-tirar")?.addEventListener("click", () => inputFuncDocCam.click());
      document.getElementById("btn-func-doc-anexar")?.addEventListener("click", () => inputFuncDocFile.click());
      document.getElementById("btn-func-doc-remover")?.addEventListener("click", () => {
        funcDocDataUrl = null;
        setFuncDocPreview(null);
      });

      inputFuncDocCam?.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        e.target.value = "";
        if (f) handleDocFile(f, (dataUrl) => { funcDocDataUrl = dataUrl; setFuncDocPreview(dataUrl); });
      });
      inputFuncDocFile?.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        e.target.value = "";
        if (f) handleDocFile(f, (dataUrl) => { funcDocDataUrl = dataUrl; setFuncDocPreview(dataUrl); });
      });

      // Fecha modal func clicando fora
      document.getElementById("modal-func")?.addEventListener("click", (e) => {
        if (e.target.id === "modal-func") closeFuncModal();
      });
    });
  </script>
</body>
</html>
